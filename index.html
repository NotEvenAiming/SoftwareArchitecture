<!DOCTYPE html>
<html>
<head>
  <title>Upload file to S3</title>
  <script src="https://unpkg.com/vue"></script>
  <script src="https://unpkg.com/axios@0.2.1/dist/axios.min.js"></script>
</head>

<body>
  <div id="app">
    <h1>2EA2 FILE SERVICE</h1>
    <div v-if="!image">
      <h2>Select a File</h2>
      <input id="upload" type="file" @change="onFileChange">
    </div>
    <div v-else>
      <button v-if="!uploadURL" @click="removeImage">Remove File</button>
      <button v-if="!uploadURL" @click="uploadImage">Upload File</button><br><br>
      <input type="checkbox" id="usepw"/>
      <label for="password">Password: </label>
      <input type="text" id="password" disabled /><br><br>
      <label for="maxdownloads">Maxiumum number of downloads: </label>
      <input type="text" id="maxdownloads" name="maxdownloads">
    </div>
    <div>
      <button @click="downloadFile()">Download</button>
      <label for="uuidinput">Enter uuid: </label>
      <input type="text" id="uuidinput" name="uuidinput">
      <a href="" id="link"></a>
    </div>
    <h2 v-if="uploadURL">Success! File uploaded.</h2>
  </div>

  <script>
    document.getElementById('usepw').onchange = function() {
    document.getElementById('password').enabled = this.checked;
};
    const MAX_IMAGE_SIZE = 1000000;
    const API_ENDPOINT = 'https://0xyfrpolm1.execute-api.us-east-1.amazonaws.com/dev'
    new Vue({
      el: "#app",
      data: {
        image: '',
        uploadURL: '',
        filename: ''
      },
      methods: {
        downloadFile: async function (e) {
          console.log("download clicked");
          var uuidinputval = document.getElementById('uuidinput').value;
          console.log(uuidinputval);
          const response = await axios({
            method: 'GET',
            url: API_ENDPOINT,
            headers: {
              UUID: uuidinputval,
              "Content-Type": "application/json"
            }
          })
          console.log('Response: ', response);
          console.log(response.body.url);
          var downloadurl = response.body.url;
          var link = document.getElementById("link");
          link.innerHTML = "Download Link";

          link.setAttribute('href', downloadurl);
        },
        onFileChange(e) {
          let files = e.target.files || e.dataTransfer.files
          if (!files.length) return
          this.createImage(files[0])
          var fullPath = document.getElementById('upload').value;

          if (fullPath) {
            var startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
            filename = fullPath.substring(startIndex);
            if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
              filename = filename.substring(1);
            }
          }
        },
        createImage(file) {
          let reader = new FileReader()
          reader.onload = (e) => {
            console.log('length: ', e.target.result.includes('data:image/jpeg'))
            if (!e.target.result.includes('data:image/jpeg')) {
              //return alert('Wrong file type - JPG only.')
            }
            if (e.target.result.length > MAX_IMAGE_SIZE) {
              //return alert('Image is loo large.')
            }
            this.image = e.target.result
          }
          reader.readAsDataURL(file)
        },
        removeImage: function (e) {
          console.log('Remove clicked')
          this.image = ''
        },
        uploadImage: async function (e) {

          var passwordval = document.getElementById('password').value;
          var maxdownloadval = document.getElementById('maxdownloads').value;
          console.log('Upload clicked')
          // Get the presigned URL
          const response = await axios({
            method: 'post',
            url: API_ENDPOINT,
            data: {
              object_key: filename,
              password: passwordval,
              rd: maxdownloadval
            }
          })
          console.log('Response: ', response)
          console.log('Uploading: ', this.image)
          let binary = atob(this.image.split(',')[1])
          let array = []
          for (var i = 0; i < binary.length; i++) {
            array.push(binary.charCodeAt(i))
          }
          let blobData = new Blob([new Uint8Array(array)], { type: 'image/jpeg' })
          console.log('Uploading to: ', response.url)
          const result = await fetch(response.url, {
            method: 'PUT',
            body: blobData
          })
          console.log('Result: ', result)
          alert(response.UUID);
          // Final URL for the user doesn't need the query string params
          this.url = response.url.split('?')[0]
        }

      }

    })
  </script>
  <style type="text/css">
    body {
      background: #20262E;
      padding: 20px;
      font-family: sans-serif;
    }

    #app {
      background: #fff;
      border-radius: 4px;
      padding: 20px;
      transition: all 0.2s;
      text-align: center;
    }

    #logo {
      width: 100px;
    }

    h2 {
      font-weight: bold;
      margin-bottom: 15px;
    }

    h1,
    h2 {
      font-weight: normal;
      margin-bottom: 15px;
    }

    a {
      color: #42b983;
    }

    img {
      width: 30%;
      margin: auto;
      display: block;
      margin-bottom: 10px;
    }
  </style>
</body>

</html>